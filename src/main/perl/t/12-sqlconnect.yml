name: <sqlconnect>
test: |
  <try>
    <null:dsn dbi:mysql:bedrock:%s>
    <null:host --default=localhost $env.DBI_HOST>
    <array:args $dsn.sprintf($host)>
    
    <if $env.DBI_SOCKET>
       <null $args.push('mysql_socket', $env.DBI_SOCKET)>
    </if>
    
    <sqlconnect:dbi --username=fred --password=flintstone $args>

    <iif $dbi success 'no dbi'>
  <catch>
    <var $@>
  </try>
result: /success/s
op: like
---
name: <sqlconnect --dsn="bedrock">
test: |
  <try>
    <sqlconnect:dbi --verbose --dsn="bedrock" mysql_socket $env.DBI_SOCKET>
    <iif $dbi success 'no dbi'>
  <catch>
    <var $@>
  </try>
result: /success/s
op: like
---
name: <sqlconnect> dsn, but no user
env:
  DBI_USER:
  DBI_PASS:
config:
  DBI_USER:
test: |
  <try>
    <sqlconnect:dbi --verbose dbi:mysql:bedrock:localhost mysql_socket $env.DBI_SOCKET>
    <iif $dbi success 'no dbi'>
  <catch>
    <var $@>
  </try>
result: '/no user found/'
op: like
---
env:
  DBI_DSN:
name: <sqlconnect> no dsn && no user
test: |
  <try>
    <sqlconnect:dbi --verbose  >
    <iif $dbi success 'no dbi'>
  <catch>
    <var $@>
  </try>
result: '/no dsn found/'
op: like
config:
  DBI_USER:
  DBI_DSN:
---
name: <sqlconnect> dbi stored?
test: |
  <try>
    <sqlconnect:dbi --verbose --username=fred --password=flintstone dbi:mysql:bedrock:localhost mysql_socket $env.DBI_SOCKET  >
    <var $dbi.ping()>
  <catch>
    <var $@>
  </try>
result: '/^\s*1\s*/s'
op: like
---
name: <sqlconnect> dbi valid
test: |
  <try>
    <sqlconnect:dbi --username=fred --password=flintstone dbi:mysql:bedrock:127.0.0.1 >
    <trace --output $dbi>
    <sqlselect --verbose --db="dbi" "select * from foo">
      <var $id>,<var $name>
    </sqlselect>
  <catch>
    <var $@>
  </try>
result: '/1,test/'
op: like
---
name: <sqlconnect> dsn, but no user
env:
  DBI_USER:
  DBI_PASS:
config:
  DBI_USER:
  DBI_PASS:
  DBI_DSN:
  DBI_HOST:
test: |
  <sqlconnect:dbi --verbose dbi:mysql:bedrock:localhost mysql_socket $env.DBI_SOCKET>
error: '/no user found/'
