#
# Unit tests for the <sink> tag caching functionality
# Corrected to use <null> for retrieval
#

---
name: Sink Cache Write (Capture and Cache)
env:
  BEDROCK_CACHE_ENGINE: Redis
  CONFIG_PATH: t/conf
test: |
  <sink:sink_test_var --cache="sink_test_key_01">Captured Content</sink>
  VAR: <var $sink_test_var>
result: |

 VAR: Captured Content
---
name: Sink Cache Persistence (Verify it is in Redis)
env:
  BEDROCK_CACHE_ENGINE: Redis
  CONFIG_PATH: t/conf
test: |
  <null:cached_val --cache="sink_test_key_01">
  <var --default="CACHE_MISS" $cached_val>
result: |

 Captured Content
---
name: Sink Cache TTL (Expiration Setup)
env:
  BEDROCK_CACHE_ENGINE: Redis
  CONFIG_PATH: t/conf
test: |
  <sink --cache="sink_test_ttl_key" --ttl="1">Quick Expiry</sink>
  <null:check --cache="sink_test_ttl_key">
  IMMEDIATE: <var --default="MISS" $check>
result: |


 IMMEDIATE: Quick Expiry
---
name: Sink Cache TTL (Expired Miss)
env:
  BEDROCK_CACHE_ENGINE: Redis
  CONFIG_PATH: t/conf
# Using 'like' to handle whitespace variations
op: like
test: |
  <null --sleep=2>
  <null:check_expired --cache="sink_test_ttl_key">
  EXPIRED: <var --default="GONE" $check_expired>
result: /EXPIRED: GONE/
