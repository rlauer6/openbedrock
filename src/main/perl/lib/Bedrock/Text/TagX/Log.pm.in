#!/usr/local/bin/perl -w

# ident "@(#) $Header$"
# ident "@(#)        $Name$"

package TagX::Log;

use strict;

BEGIN
{
    use Exporter ();
    use vars	qw ($VERSION @ISA @EXPORT @EXPORT_OK);
    $VERSION	= do { my @r = (q$Revision$ =~ /\d+/g); sprintf "%d."."%02d" x $#r, @r };
    @ISA	= qw (Exporter);
}

@EXPORT = qw (log_message);

@EXPORT_OK = qw (start_logger);

my %options = ('LOG_MAXSIZE' => 100000);

sub start_logger
{
    my %args = @_;
    return unless $args{LOG_FILE};

    my ($key, $value);
    while (($key, $value) = each %args) {
	$options{$key} = $args{$key};
    }

    my ($logfile, $maxsize) = @options{qw(LOG_FILE LOG_MAXSIZE)};
    if ( (stat($logfile))[7] > $maxsize ) {
	open ( FILE, ">$logfile");
	close FILE;
    }

    # Redirect STDERR too to append to logfile
    unless ( open( STDERR, ">> $logfile" ) ) {
	warn __PACKAGE__, ":start_logger(): Unable to append to log file $logfile: $!\n";
	return;
    }
    my $fd = IO::Handle->new_from_fd ( 'STDERR', 'a');
    $fd->autoflush ( 1 );
    $fd->close;
    print STDERR "================================================================================";

    # And log a sample message
    &log_message( undef, "started logger" );
    $SIG{__WARN__} = $SIG{__DIE__} = sub { unshift @_, undef; goto &log_message };
}

sub log_message
{
    my $obj = shift;
    return unless exists $options{LOG_FILE};

    my $logfile = $options{LOG_FILE};
    open( LOG, ">> $logfile") or return;

    # Make time
    my @t = localtime;
    my $time = sprintf "%02d/%02d/%4d %02d:%02d:%02d", $t[4]+1, $t[3], 1900+$t[5], $t[2], $t[1], $t[0];

    # Make caller
    my ($pack, $filename, $line) = caller;

    # Input location tracking
    my $loc = '';
    if ( defined( $obj ) ) {
	$loc = "[" . $obj->start_location . "]\n[$obj]\n";
    }

    # And print message
    print LOG "\n$time \[$$\]\t\t$filename($line)\n$loc@_\n";
    close LOG;
}

1;

#
# Name of Release: $Name$
# $Log$
# Revision 1.2  2000/10/17 15:37:38  sridhar
# Complains loudly (using `warn') if unable to open log file.
#
# Revision 1.1  2000/04/24 12:45:46  sridhar
# Added TagX::Log for logging messages
#
#
