package BLM::IndexedTableHandler::RecordSet;

#
#    This file is a part of Bedrock, a server-side web scripting tool.
#    Check out http://www.openbedrock.net
#    Copyright (C) 2001, Charles Jones, LLC.
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
#

use strict;

use Bedrock::Array;

use Bedrock::HTML::Helper qw( create_html_element
create_label_name
create_xhtml_element
create_radio_buttons
create_select_list
);

BEGIN {
  use Exporter ();
  use vars qw ($VERSION @ISA @ENV @EXPORT_OK @EXPORT);
}

@ISA = qw(Bedrock::RecordSet);

=pod

=head1 NAME

BLM::IndexedTableHandler::RecordSet

=head1 SYNOPSIS

    my $record_set = BLM::IndexedTableHandler::RecordSet->new(@list);

    my $ith = new BLM::IndexedTableHandler( $dbi, { id => $id, table_name => 'foo' } );

    # return all record in table as a record set
    my $record_set = $ith->find();

=head1 DESCRIPTION

Creates an object which represents a set of rows from a MySQL table.
Each element of the record set is a C<BLM::IndexedTableHandler>
object.

=head1 METHODS

=cut

=pod

=head2 asref

 asref()

Returns an array of hashes from the record set (as opposed to an array
of C<BLM::IndexedTableHandler>) objects).

=cut

sub asref {
  return new Bedrock::Array( map { $_->asref(); } @{$_[0]} );
}

=pod

=head2 html_form_header

=cut

sub html_form_header {
  my $self       = shift;
  my $attributes = shift || {};
  my $table_name = $self->[0]->{_table};

  return
  create_html_element( 'form',
                       ( name   => $table_name . '_set',
                         method => "post",
                         action => $ENV{REQUEST_URI}
                       ),
                       %$attributes
                     );
}

=pod

=head2 html_form_footer

=cut

sub html_form_footer {
  my $self = shift;
  my $attributes = shift || {};

  my $table_name = $self->[0]->{_table};

  return
  sprintf( "%s\n%s\n%s\n%s\n",
           create_html_element( 'input',
                                ( type  => 'hidden',
                                  name  => 'action',
                                  value => 'edit'
                                )
                              ),
           create_html_element( 'input',
                                ( type  => 'hidden',
                                  name  => 'table',
                                  value => $table_name
                                )
                              ),
           create_html_element( 'input', ( type => 'submit', value => 'Edit' ),
                                %{$attributes}
                              ),
           "</form>"
         );
}

=pod

=head2 html_form_body

=cut

sub html_form_body {
  my $self       = shift;
  my $labels     = shift || {};
  my $attributes = shift || {};
  my $fields     = shift;

  my $html = create_html_element( 'table', %{ $attributes->{table} } );

  $html .=
  sprintf( "%s\n", create_html_element( 'tr', %{ $attributes->{tr} } ) );

  my @columns;
  if ( $fields ) {
    @columns = @$fields;
  }
  else {
    @columns = @{ $self->[0]->fields() };
  }

  foreach ( "&nbsp;", @columns ) {
    next if $_ eq 'id';
    $html .= sprintf( "%s%s</th>\n",
                      create_html_element( 'th', %{ $attributes->{th} } ),
                      $labels->{$_} || create_label_name($_) );
  }

  $html .= "</tr>\n";

  foreach my $rec ( @{$self} ) {

    $html .=
    sprintf( "%s\n", create_html_element( 'tr', %{ $attributes->{tr} } ) );
    foreach ( "idx", @columns ) {
      next if $_ eq 'id';
      if ( $_ eq 'idx' ) {
        $html .= sprintf( "%s%s</td>\n",
                          create_html_element( 'td', %{ $attributes->{td} } ),
                          create_html_element( 'input',
                                               ( type  => 'radio',
                                                 name  => 'id',
                                                 value => $rec->{id}
                                               ),
                                               %{ $attributes->{input} }
                                             )
                        );
      }
      else {
        $html .= sprintf( "%s%s</td>\n",
                          create_html_element( 'td', %{ $attributes->{td} } ),
                          $rec->get($_) );
      }
    }

    $html .= "</tr>\n";
  }

  $html .= "</table>\n";

  return $html;
}


=pod

=head2 html_result_list

 html_result_list

=cut

sub html_result_list {
  my $self = shift;
  my $attributes = shift || {};

  my $html = create_html_element('ol', %{ $attributes->{ol}});
  my $first_field = $self->[0]->fields()->[1];

  foreach (@{$self}) {
    my $link = sprintf("%s%s</a>", 
		       create_html_element('a',
					   ( 
					    href => "?id=" . $_->{id}
					   ),
					   %{$attributes->{a}}, 
					  ),
		       $_->{$first_field}
		      );
    $html .= sprintf("%s%s</li>\n", create_html_element('li', %{ $attributes->{li}}), $link);
  }

  $html .= "</ol>";

  return $html;
}





=pod

=head1 NOTES

=head1 AUTHOR

rlauer@signatureinfo.com

=cut

1;

# Revision 1.10  2012/07/29 16:21:50  lauerrc
# - derive from Bedrock::RecordSet instead of Bedrock::Array
#
# Revision 1.9  2012/07/18 14:20:49  lauerrc
# - added the asref() method that returns an array of hash objects representing just the column data from the ITH object
#
# Revision 1.8  2011/12/01 22:02:57  eutl420
# - added a new method html_result_list() that creates a simple list of links that can be used to select a record to
#   edit
#
# Revision 1.7  2011/09/15 16:05:31  eutl420
# - perl tidy
#
# Revision 1.6  2011/07/17 16:56:08  eutl420
# - build .pm from .pm.in, added @PERL@
#
# Revision 1.5  2011/07/12 19:10:35  eutl420
# set VERSION from cvs Revision keyword
#
# Revision 1.4  2009/12/28 20:32:33  rlauer
# move SIS:: up to Bedrock::
#
# Revision 1.3  2008/12/03 14:01:19  alans
# We now use a hard-coded value for module $VERSION rather than a munged
# version of the expansion of the CVS 'Revision' keyword; the module API
# version number is orthogonal to the identifyer in the source control
# system.
#
# This change makes it safe to import the Bedrock codebase into another
# source repository (even CVS!) without breaking the code. We hit this
# issue when we first released the libbedrock-perl .deb package, for which
# we imported the release tarball sources into the 'bedrock-deb' CVS project.
#
# Revision 1.2  2008/11/25 19:04:13  rlauer
# changes based on Bedrock 2.0 migration plan
#
