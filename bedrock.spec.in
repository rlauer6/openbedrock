%define name		@PACKAGE@
%define release         @BEDROCK_RELEASE@
%define project_version @VERSION@
%define buildroot %{_tmppath}/%{name}-%{version}-%{release}-%(%{__id_u} -n)

Provides: @PACKAGE_NAME@

%define project_base @PACKAGE_NAME@

Name:     %{project_base}
Version:  %(echo @VERSION@ | awk -F- '{print $1}')
Release:  %{release}
Vendor:   www.openbedrock.net
Source:   %{project_base}-%{project_version}.tar.gz

BuildRoot:	%{buildroot}
Summary: 	Bedrock	
License: 	GPL
Prefix: 	/usr
Group: 		Development/Tools

Requires:       mod_perl

Provides:       perl(Bedrock), perl(VERSION), perl(Bedrock::Text::URLEncode)
Provides:       perl(Bedrock::BedrockConfig), perl(Bedrock::BedrockJSON) perl(Bedrock::BedrockCGI)

BuildArch:      noarch

%define pkgname %{project_base}-%{project_version}
%define _prefix         %{prefix}
%define _sysconfdir     %{_prefix}/etc
%define _datadir        %{_prefix}/share
%define _localstatedir  %{_prefix}/var
%define _mandir         %{_prefix}/man
%define _infodir        %{_prefix}/info
%define _libdir         %{_prefix}/lib
%define _bindir         %{_prefix}/bin
%define _libexecdir     %{_prefix}/libexec
%define _sbindir        %{_prefix}/sbin
%define _includedir     %{_prefix}/include

%description
Bedrock is a web development framework written in perl.
For more information visit: http://www.openbedrock.net

%prep
%setup -q -n %{pkgname}

%build
%{configure} --with-apache-layout=RedHat
make

%install
rm -rf %{buildroot}
DONT_STRIP=1 make DESTDIR=%{buildroot} install

mkdir -p %{buildroot}/var/www/cgi-bin
mkdir -p %{buildroot}/var/www/html
mkdir -p %{buildroot}/etc/httpd/conf.d
mkdir -p %{buildroot}/var/www/html/bedrock
mkdir -p %{buildroot}/var/www/pebbles
mkdir -p %{buildroot}/var/www/include
mkdir -p %{buildroot}/var/www/log/html
mkdir -p %{buildroot}/var/www/session
mkdir -p %{buildroot}%{_libdir}/bedrock/config.d

for a in index.rock error.roc itworks.rock notworking.html; do 
  cp %{buildroot}/%{_datadir}/bedrock/htdocs/$a %{buildroot}/var/www/html
done

cp %{buildroot}/%{_libdir}/bedrock/config/perl_bedrock.conf %{buildroot}/etc/httpd/conf.d
cp %{buildroot}/%{_libdir}/bedrock/cgi-bin/bedrock.cgi %{buildroot}/var/www/cgi-bin/bedrock.cgi

%clean
rm -rf %{buildroot}

%files
%defattr(-,root,root)

%config(noreplace) /etc/httpd/conf.d/perl_bedrock.conf

%config(noreplace) %{_libdir}/bedrock/config/tagx.xml
%config(noreplace) %{_libdir}/bedrock/config/tagx_apps.xml
%config(noreplace) %{_libdir}/bedrock/config/bedrock.users

%{_libdir}/bedrock/config/startup.pl
%{_libdir}/bedrock/config/perl_bedrock.conf

%{_datadir}/doc
/bin/bedrock
%{_bindir}/bedrock-cache.pl
%{_bindir}/bedrock-plugin
%{_bindir}/bedrock-plugin.pl
%{_bindir}/bedrock.pl
%{_datadir}/bedrock-perl5-inc-begin-block.snippet
%{_mandir}/man1
%{_datadir}/bedrock
%{_libdir}/bedrock/perl5
%{_libdir}/bedrock/cgi-bin/bedrock.cgi
%{_libdir}/bedrock/cgi-bin/bedrock-session-files.cgi
%{_libdir}/bedrock/cgi-bin/bedrock-docs.cgi


%defattr(-,apache,apache)
/var/www/html
/var/www/include
/var/www/pebbles
/var/www/session
/var/www/cgi-bin
/var/www/log

