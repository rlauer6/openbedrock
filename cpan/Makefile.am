SUBDIRS = . bedrock-core

CPAN_DIST_MAKER = make-cpan-dist.pl

PACKAGE_VERSION = @PACKAGE_VERSION@

TARBALL = $(builddir)/Bedrock-$(PACKAGE_VERSION).tar.gz

REQUIRES_FILE = $(srcdir)/requires
TEST_REQUIRES_FILE = $(srcdir)/test-requires

all:

EXCLUDE_LIST = \
    Bedrock/Apache/Request/Shell.pm \
    Bedrock/Context.pm \
    Bedrock/Handler.pm \
    Bedrock/Apache/Bedrock.pm \
    Bedrock/Apache/Constants.pm \
    Bedrock/VERSION.pm \
    Bedrock/Array.pm \
    Bedrock/BedrockConfig.pm \
    Bedrock/BedrockJSON.pm \
    Bedrock/BufferStream.pm \
    Bedrock/Constants.pm \
    Bedrock/DBI/Utils.pm \
    Bedrock/Dump.pm \
    Bedrock/Dumper.pm \
    Bedrock/Hash.pm \
    Bedrock/HTML/Helper.pm \
    Bedrock/LoadConfig.pm \
    Bedrock/Log.pm \
    Bedrock/Logger.pm \
    Bedrock/Model/Role.pm \
    Bedrock/Model/Field.pm \
    Bedrock/Model/Handler.pm \
    Bedrock/Object.pm \
    Bedrock/Plugin.pm \
    Bedrock/RegExp.pm \
    Bedrock/Role/Config.pm \
    Bedrock/Serializer.pm \
    Bedrock/Serializer/BedrockXML.pm \
    Bedrock/Serializer/JSON.pm \
    Bedrock/Serializer/YAML.pm \
    Bedrock/Serializer/XML.pm \
    Bedrock/Snippet.pm \
    Bedrock/Template.pm \
    Bedrock/Template/Email.pm \
    Bedrock/Text/URLEncode.pm \
    Bedrock/Text/TagX.pm \
    Bedrock/Text/TagX/Error.pm \
    Bedrock/Text/TagX/Expr.pm \
    Bedrock/Text/TagX/Func.pm \
    Bedrock/Text/TagX/Output.pm \
    Bedrock/Text/TagX/Parser.pm \
    Bedrock/Text/TagX/Scalar.pm \
    Bedrock/Text/TagX/Symtab.pm \
    Bedrock/Text/TagX/TAG.pm \
    Bedrock/Text/TagX/TAG/NoBody.pm \
    Bedrock/Text/TagX/TAG/NoBody/Array.pm \
    Bedrock/Text/TagX/TAG/NoBody/Case.pm \
    Bedrock/Text/TagX/TAG/NoBody/Comment.pm \
    Bedrock/Text/TagX/TAG/NoBody/Exec.pm \
    Bedrock/Text/TagX/TAG/NoBody/Flush.pm \
    Bedrock/Text/TagX/TAG/NoBody/Hash.pm \
    Bedrock/Text/TagX/TAG/NoBody/Iif.pm \
    Bedrock/Text/TagX/TAG/NoBody/Include.pm \
    Bedrock/Text/TagX/TAG/NoBody/NULL.pm \
    Bedrock/Text/TagX/TAG/NoBody/Open.pm \
    Bedrock/Text/TagX/TAG/NoBody/Pebble.pm \
    Bedrock/Text/TagX/TAG/NoBody/Plugin.pm \
    Bedrock/Text/TagX/TAG/NoBody/Raise.pm \
    Bedrock/Text/TagX/TAG/NoBody/RecordSet.pm \
    Bedrock/Text/TagX/TAG/NoBody/SQL.pm \
    Bedrock/Text/TagX/TAG/NoBody/SQLCommit.pm \
    Bedrock/Text/TagX/TAG/NoBody/SQLConnect.pm \
    Bedrock/Text/TagX/TAG/NoBody/SQLRollback.pm \
    Bedrock/Text/TagX/TAG/NoBody/SQLTable.pm \
    Bedrock/Text/TagX/TAG/NoBody/Trace.pm \
    Bedrock/Text/TagX/TAG/NoBody/Var.pm \
    Bedrock/Text/TagX/TAG/SQLConnector.pm \
    Bedrock/Text/TagX/TAG/SQLHandler.pm \
    Bedrock/Text/TagX/TAG/WithBody.pm \
    Bedrock/Text/TagX/TAG/WithBody/Cache.pm \
    Bedrock/Text/TagX/TAG/WithBody/Catch.pm \
    Bedrock/Text/TagX/TAG/WithBody/If.pm \
    Bedrock/Text/TagX/TAG/WithBody/If/Else.pm \
    Bedrock/Text/TagX/TAG/WithBody/Loop.pm \
    Bedrock/Text/TagX/TAG/WithBody/Loop/Foreach.pm \
    Bedrock/Text/TagX/TAG/WithBody/Loop/SQLSelect.pm \
    Bedrock/Text/TagX/TAG/WithBody/Loop/While.pm \
    Bedrock/Text/TagX/TAG/WithBody/NoExec.pm \
    Bedrock/Text/TagX/TAG/WithBody/PebbleDef.pm \
    Bedrock/Text/TagX/TAG/WithBody/Sink.pm \
    Bedrock/Text/TagX/TAG/WithBody/Snippet.pm \
    Bedrock/Text/TagX/TAG/WithBody/Try.pm \
    Bedrock/Text/TagX/TAG/WithBody/Unless.pm \
    Bedrock/Text/TagX/Term.pm \
    Bedrock/Text/TagX/Term/String.pm \
    Bedrock/Text/TagX/Term/Var.pm \
    Bedrock/XML.pm \
    Bedrock/XML/Container.pm \
    Bedrock/XML/Container/Array.pm \
    Bedrock/XML/Container/Object.pm \
    Bedrock/XML/Container/Scalar.pm \
    BLM/DBHandler.pm \
    BLM/Awk.pm \
    BLM/Benchmark.pm \
    BLM/DBHandler.pm \
    BLM/Date.pm \
    BLM/FTP.pm \
    BLM/FileIO.pm \
    BLM/Filter.pm \
    BLM/Filter/crypt.pm \
    BLM/Filter/csv.pm \
    BLM/Filter/xls.pm \
    BLM/JSON.pm \
    BLM/Plugin.pm \
    BLM/Mail.pm \
    BLM/Plugin.pm \
    BLM/Recycle.pm \
    BLM/SMTP.pm \
    BLM/ShareDir.pm \
    BLM/Session.pm \
    BLM/Source.pm \
    BLM/Stat.pm \
    BLM/Timenow.pm \
    BLM/Startup/Header.pm \
    BLM/Startup/Input.pm \
    BLM/Startup/Config.pm \
    BLM/Startup/Env.pm \
    BLM/Startup/Bedrock.pm \
    BLM/IndexedTableHandler.pm \
    BLM/IndexedTableHandler/Common.pm \
    BLM/IndexedTableHandler/RecordSet.pm

.PHONY: cpan
cpan: $(TARBALL)

if RPMBUILD_ENABLED
$(TARBALL):
	touch $@
else
tmpdir := $(shell mktemp -d)

$(TARBALL): buildspec.yml
	if [[ -z "$(DESTDIR)" ]]; then \
	  rm -f exclude_files; \
	  for a in $(EXCLUDE_LIST); do \
	    echo $(tmpdir)/usr/share/perl5/$$a >>exclude_files; \
	  done; \
	  $(MAKE) -C $(top_builddir) prefix=/usr install DESTDIR=$(tmpdir); \
	fi
	trap 'rm -rf "$(tmpdir)"' EXIT INT TERM HUP; \
	if [[ -n "$(DESTDIR)" ]]; then \
	  project_root="$(DESTDIR)/usr"; \
	else \
	  project_root="$(tmpdir)/usr"; \
	fi; \
	[[ -n "$$DEBUG" ]] && set -x; \
	[[ -n "$$DEBUG" ]] && DEBUG="--debug"; \
	REQUIRES="-r $$project_root/share/bedrock/requires"; \
	[[ -n "$(NOCLEANUP)" ]] && NOCLEANUP="--no-cleanup"; \
	[[ -n "$(DRYRUN)"    ]] && DRYRUN="--dryrun"; \
	[[ -n "$(SCANDEPS)"  ]] && SCANDEPS="-s"; \
	[[ -n "$(NOVERSION)" ]] && NOVERSION="-n"; \
	PROJECT_ROOT="--project-root $$project_root"; \
	SKIP_TESTS=1 \
	$(CPAN_DIST_MAKER) $$PROJECT_ROOT $$REQUIRES \
	  $$DRYRUN $$SCANDEPS $$NOVERSION $$NOCLEANUP $$DEBUG -b $<;
endif

cpandir = $(datadir)/bedrock

dist_cpan_DATA = \
    requires \
    test-requires \
    buildspec.yml \
    postamble

CLEANFILES = \
    extra-files \
    provides \
    resources 

clean-local:
	for a in $(CLEANFILES); do \
	  rm -f $$a || true; \
	done
	rm -f *.tar.gz
	rm -f *.tmp
