#!/usr/bin/env bash
# -*- mode: sh; -*-

# 1. Initialize variables
EXIT_CODE=0
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.p[ml]\.in$')

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# 2. Check if there are any files to process
if [ -z "$STAGED_FILES" ]; then
    exit 0
fi

echo -e "${YELLOW}Running Perl pre-commit checks...${NC}"

# 3. Loop through changed files
for file in $STAGED_FILES; do
    
    # Define the target name (stripping .in) for Critic
    # Logic: Source is 'file.pm.in', Critic checks generated 'file.pm'
    target_file=${file%%.in}

    # --- Step A: Perl Critic ---
    # Only run if the target file actually exists on disk
    if [ -f "$target_file" ]; then
        echo -n "  Checking Critic (severity >= 3) on $target_file... "
        
        # Capture output, force severity 3, strict
        CRITIC_OUT=$(perlcritic --severity 3 --nocolor "$target_file" 2>&1)
        CRITIC_STATUS=$?

        if [ $CRITIC_STATUS -eq 0 ]; then
            echo -e "${GREEN}OK${NC}"
        else
            echo -e "${RED}FAIL${NC}"
            echo "$CRITIC_OUT"
            EXIT_CODE=1
        fi
    else
        echo -e "${YELLOW}  Skipping Critic on $target_file (File not found, perhaps not generated yet?)${NC}"
    fi

    # --- Step B: Perl Tidy ---
    # Run tidy on the original .in file
    echo -n "  Checking Tidy on $file... "
    
    # -ast: assert tidy (returns error if file changes)
    # -se: send errors to standard error
    # -b: backup (prevented by -ast, but good practice to be explicit about not writing)
    perltidy -ast -se "$file" > /dev/null 2>&1
    TIDY_STATUS=$?

    if [ $TIDY_STATUS -eq 0 ]; then
        echo -e "${GREEN}OK${NC}"
    else
        echo -e "${RED}FAIL${NC}"
        echo -e "    File is not tidy. Run: ${YELLOW}perltidy -b $file${NC}"
        EXIT_CODE=1
    fi

done

# 4. Final Conclusion
if [ $EXIT_CODE -ne 0 ]; then
    echo -e "\n${RED}Commit rejected due to Perl errors.${NC}"
fi

exit $EXIT_CODE
